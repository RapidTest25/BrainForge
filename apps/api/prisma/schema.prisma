generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum AIProviderEnum {
  OPENAI
  CLAUDE
  GEMINI
  GROQ
  MISTRAL
  DEEPSEEK
  OPENROUTER
  OLLAMA
  COPILOT
  CUSTOM
}

enum BrainstormMode {
  BRAINSTORM
  DEBATE
  ANALYSIS
  FREEFORM
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum SprintStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum DiagramType {
  ERD
  FLOWCHART
  ARCHITECTURE
  SEQUENCE
  MINDMAP
  USERFLOW
  FREEFORM
  COMPONENT
}

enum EventType {
  TASK_DEADLINE
  SPRINT_MILESTONE
  BRAINSTORM_SESSION
  CUSTOM_EVENT
  MEETING
}

// ==========================================
// USER & AUTH
// ==========================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  googleId     String?  @unique
  name         String
  avatarUrl    String?
  isAdmin      Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ownedTeams         Team[]
  teamMemberships    TeamMember[]
  aiKeys             UserAIKey[]
  brainstormSessions BrainstormSession[]
  sentInvitations    TeamInvitation[]    @relation("inviter")
  createdTasks       Task[]              @relation("taskCreator")
  taskAssignments    TaskAssignee[]
  taskComments       TaskComment[]
  notes              Note[]
  diagrams           Diagram[]
  calendarEvents     CalendarEvent[]
  aiUsageLogs        AIUsageLog[]
  sprintPlans        SprintPlan[]
  noteHistories      NoteHistory[]
  discussions        Discussion[]
  discussionReplies  DiscussionReply[]
  goals              Goal[]
  notifications      Notification[]
  brainstormMessages BrainstormMessage[]
  aiChats            AiChat[]
  projects           Project[]
}

// ==========================================
// TEAM
// ==========================================

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner              User               @relation(fields: [ownerId], references: [id])
  members            TeamMember[]
  invitations        TeamInvitation[]
  tasks              Task[]
  brainstormSessions BrainstormSession[]
  sprintPlans        SprintPlan[]
  notes              Note[]
  diagrams           Diagram[]
  calendarEvents     CalendarEvent[]
  labels             Label[]
  discussions        Discussion[]
  goals              Goal[]
  notifications      Notification[]
  aiChats            AiChat[]
  projects           Project[]
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

model TeamInvitation {
  id        String           @id @default(cuid())
  teamId    String
  email     String
  invitedBy String
  role      TeamRole         @default(MEMBER)
  status    InvitationStatus @default(PENDING)
  token     String           @unique
  expiresAt DateTime
  createdAt DateTime         @default(now())

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inviter User @relation("inviter", fields: [invitedBy], references: [id])
}

// ==========================================
// AI KEY (BYOK)
// ==========================================

model UserAIKey {
  id           String         @id @default(cuid())
  userId       String
  provider     AIProviderEnum
  encryptedKey String
  label        String?
  isActive     Boolean        @default(true)
  lastUsedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// PROJECT / WORKSPACE
// ==========================================

model Project {
  id          String   @id @default(cuid())
  teamId      String
  name        String
  description String?
  color       String   @default("#7b68ee")
  icon        String   @default("folder")
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team               Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator            User               @relation(fields: [createdBy], references: [id])
  tasks              Task[]
  brainstormSessions BrainstormSession[]
  sprintPlans        SprintPlan[]
  notes              Note[]
  diagrams           Diagram[]
  goals              Goal[]
  aiChats            AiChat[]
}

// ==========================================
// TASKS (ClickUp-inspired)
// ==========================================

model Task {
  id          String       @id @default(cuid())
  teamId      String
  projectId   String?
  sprintId    String?
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  createdBy   String
  estimation  Int?
  timeSpent   Int?
  orderIndex  Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  team         Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project      Project?         @relation(fields: [projectId], references: [id])
  sprint       SprintPlan?      @relation(fields: [sprintId], references: [id])
  creator      User             @relation("taskCreator", fields: [createdBy], references: [id])
  assignees    TaskAssignee[]
  labels       TaskLabel[]
  comments     TaskComment[]
  dependencies TaskDependency[] @relation("dependentTask")
  dependents   TaskDependency[] @relation("dependencyTask")
  activities   TaskActivity[]
}

model TaskAssignee {
  id     String @id @default(cuid())
  taskId String
  userId String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@unique([taskId, userId])
}

model Label {
  id     String @id @default(cuid())
  teamId String
  name   String
  color  String

  team  Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tasks TaskLabel[]

  @@unique([teamId, name])
}

model TaskLabel {
  taskId  String
  labelId String

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([taskId, labelId])
}

model TaskDependency {
  id               String @id @default(cuid())
  dependentTaskId  String
  dependencyTaskId String

  dependentTask  Task @relation("dependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
  dependencyTask Task @relation("dependencyTask", fields: [dependencyTaskId], references: [id], onDelete: Cascade)

  @@unique([dependentTaskId, dependencyTaskId])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  action    String
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// ==========================================
// GOALS
// ==========================================

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model Goal {
  id          String     @id @default(cuid())
  teamId      String
  projectId   String?
  createdBy   String
  title       String
  description String?    @db.Text
  status      GoalStatus @default(NOT_STARTED)
  progress    Int        @default(0)
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  creator User     @relation(fields: [createdBy], references: [id])
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  title     String
  message   String?  @db.Text
  type      String   @default("info")
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// BRAINSTORM
// ==========================================

model BrainstormSession {
  id             String         @id @default(cuid())
  teamId         String
  projectId      String?
  createdBy      String
  title          String
  mode           BrainstormMode
  context        String?        @db.Text
  isActive       Boolean        @default(true)
  whiteboardData Json?
  flowData       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  team     Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project  Project?           @relation(fields: [projectId], references: [id])
  creator  User               @relation(fields: [createdBy], references: [id])
  messages BrainstormMessage[]
}

model BrainstormMessage {
  id        String      @id @default(cuid())
  sessionId String
  userId    String?
  role      MessageRole
  content   String      @db.Text
  isPinned  Boolean     @default(false)
  fileUrl   String?
  fileName  String?
  fileType  String?
  isEdited  Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt

  session BrainstormSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User?             @relation(fields: [userId], references: [id])
}

// ==========================================
// SPRINT
// ==========================================

model SprintPlan {
  id        String       @id @default(cuid())
  teamId    String
  projectId String?
  createdBy String
  title     String
  goal      String       @db.Text
  deadline  DateTime
  teamSize  Int          @default(1)
  status    SprintStatus @default(DRAFT)
  data      Json         @default("{}")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  creator User     @relation(fields: [createdBy], references: [id])
  tasks   Task[]
}

// ==========================================
// DIAGRAMS
// ==========================================

model Diagram {
  id          String      @id @default(cuid())
  teamId      String
  projectId   String?
  createdBy   String
  title       String
  description String?
  type        DiagramType
  data        Json        @default("{\"nodes\":[],\"edges\":[]}")
  thumbnail   String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  team    Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  creator User     @relation(fields: [createdBy], references: [id])
}

// ==========================================
// CALENDAR
// ==========================================

model CalendarEvent {
  id          String    @id @default(cuid())
  teamId      String
  createdBy   String
  title       String
  description String?
  type        EventType
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  color       String?
  taskId      String?
  sprintId    String?
  sessionId   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator User @relation(fields: [createdBy], references: [id])
}

// ==========================================
// NOTES
// ==========================================

model Note {
  id        String   @id @default(cuid())
  teamId    String
  projectId String?
  createdBy String
  title     String
  content   String   @db.Text @default("")
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team    Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project?      @relation(fields: [projectId], references: [id])
  creator User          @relation(fields: [createdBy], references: [id])
  history NoteHistory[]
}

model NoteHistory {
  id        String   @id @default(cuid())
  noteId    String
  content   String   @db.Text
  version   Int
  editedBy  String
  createdAt DateTime @default(now())

  note   Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  editor User @relation(fields: [editedBy], references: [id])
}

// ==========================================
// DISCUSSIONS
// ==========================================

model Discussion {
  id        String   @id @default(cuid())
  teamId    String
  createdBy String
  title     String
  content   String   @db.Text
  category  String   @default("general")
  isPinned  Boolean  @default(false)
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team    Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator User              @relation(fields: [createdBy], references: [id])
  replies DiscussionReply[]
}

model DiscussionReply {
  id           String   @id @default(cuid())
  discussionId String
  userId       String
  content      String   @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])
}

// ==========================================
// AI CHAT
// ==========================================

model AiChat {
  id        String   @id @default(cuid())
  teamId    String
  projectId String?
  createdBy String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team     Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project  Project?        @relation(fields: [projectId], references: [id])
  creator  User            @relation(fields: [createdBy], references: [id])
  messages AiChatMessage[]
}

model AiChatMessage {
  id        String      @id @default(cuid())
  chatId    String
  role      MessageRole
  content   String      @db.Text
  provider  String?
  model     String?
  createdAt DateTime    @default(now())

  chat AiChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
}

// ==========================================
// AI USAGE TRACKING
// ==========================================

model AIUsageLog {
  id               String   @id @default(cuid())
  userId           String
  provider         String
  model            String
  promptTokens     Int
  completionTokens Int
  estimatedCost    Float
  feature          String
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ==========================================
// SYSTEM SETTINGS
// ==========================================

model SystemSetting {
  id        String   @id @default(cuid())
  category  String   // e.g. 'general', 'email', 'security', 'ai', 'notifications'
  key       String
  value     String   @db.Text
  type      String   @default("string") // string, number, boolean, json
  label     String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([category, key])
  @@index([category])
}
